<!doctype html>
<html>
<head>
  
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <title >ElectroSpindle Dashboard</title>
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">

    <link rel="stylesheet" href="calendar.css">

    <link rel="stylesheet" href="./style_index.css"></link>
    <script>
        //inizializzazione array di colori per i grafici
        var colors = [
  '#ff7f50','#87cefa','#da70d6','#32cd32','#6495ed',
  '#ff69b4','#ba55d3','#cd5c5c','#ffa500','#40e0d0'
    ];

    
        
    
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>
</head>


<body>
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
<h1>ElectroSpindle: Dashboard</h1>
<!-- <Body background="images/PROVA.png" background-repeat="no-repeat” background-size="cover”>  -->
<!--<Body background="images/test.png" background-repeat="no-repeat” background-size="cover”></Body>-->  
  Model <select id="modello"></select>
 
Insert Spindle SN <input type = "text" id ="request" maxlength="10" required placeholder="Serial Number"> 





<!-- Initialize a select button -->
<!--<button id = "clear" onclick="clearSvg()" class = "button-blue">Rimuovi tutto</button> -->
<!--<input type="checkbox" id ="sovrapponi" onchange = "checkElements()"> Sovrapponi grafici-->
<!--<input type="checkbox" id ="separati" onchange = "separati()"> Separati -->
<br> <br>
Breakins available from 10/01/2022 to 21/09/2022

<br> <br>

<div class = "button-wrapper">
  <h4>Pick date</h4>
  <button class = "button-green" onclick = "displayCalendar(0)" id = "daButton">From</button>

  <div id = "day-start">  </div>

  <br>
  <br>
<button class = "button-green" onclick = "displayCalendar(1)" id = "aButton" disabled = true >To</button>


<div id = "day-end">  </div>

</div>


<div class="calendar" id = "calendar-original" hidden="true">
  <div class="calendar-header">
      <span class="month-picker" id="month-picker">February</span>
      <div class="year-picker">
          <span class="year-change" id="prev-year">
              <pre><</pre>
          </span>
          <span id="year">2021</span>
          <span class="year-change" id="next-year">
              <pre>></pre>
          </span>
      </div>
  </div>
  <div class="calendar-body" id = "calendar-body">
      <div class="calendar-week-day">
          <div>Sun</div>
          <div>Mon</div>
          <div>Tue</div>
          <div>Wed</div>
          <div>Thu</div>
          <div>Fri</div>
          <div>Sat</div>
      </div>
      <div class="calendar-days"></div>
  </div>
  <div class="calendar-footer">
      <div class="toggle">

      </div>
  </div>
  <div class="month-list" id = "month-list"></div>
</div>
<button class="button-green" id="submit" onclick="resetFilters()">Reset filters</button>

<div id="dstCalendar">
 
</div>


<script src="calendar.js"></script>




<div id = "coordinates"></div>
<!--<a href="aggregateView.html" target="_blank" rel="noopener noreferrer">Visualizzazione aggregata</a>
<a href="separateView.html" target="_blank" rel="noopener noreferrer">Visualizzazione separata</a> -->
<h3>Available Spindles</h3> 
<!--<input type = "checkbox" onchange = "selectAll()">Select All-->
<div id = "availableSpindles" style = "overflow-y: scroll; height:250px;">  
<div class = "header">
  <span id = "snSpan">
    SN
  </span>
  <span id = "modelSpan">
    Model
  </span>
  <span id = "breakinSpan">
    Breakin date
  </span>

</div>


</div>

<h3 style = "top: 400px;">Selected Spindles</h3> <br>
<div id = "divselectAll0">
  <input type = "checkbox" id="selectAll0" onchange = "selectAll(0)" >Select All
</div>
<div id ="divselectAll1">
  <input type = "checkbox" id="selectAll1" onchange = "selectAll(1)" >Select All
</div>
<div id = "selectedSpindles" style = "overflow-y: scroll; height:150px;">
  <div class="header">
    <span id="snSpan">
      SN
    </span>
    <span id="modelSpan">
      Model
    </span>
    <span id="breakinSpan">
      Breakin date
    </span>
    </div>
</div>

<button id = 'cerca' class = 'button-blue' onClick='redirectView()'>Search</button>
<button id = 'clearSelected' class = 'button-green' onClick='clearSelectedSpindles()'>Clear</button>


<script>



function clearSelectedSpindles(){

  document.getElementById("selectedSpindles").innerHTML = "<div class='header'><span id = 'snSpan'>SN</span><span id = 'modelSpan'>Model</span><span id = 'breakinSpan'>Breakin date</span></div>"
  
}

  function clearAvailableSpindles() {

    document.getElementById("availableSpindles").innerHTML = "<div class='header'><span id = 'snSpan'>SN</span><span id = 'modelSpan'>Model</span><span id = 'breakinSpan'>Breakin date</span></div>"

  }


function sleep (time) {
  return new Promise((resolve) => setTimeout(resolve, time));
}

function saveSpindle(sn){


  id_and_sn = JSON.parse(localStorage.getItem("id_and_sn"))
  var to_write = ""

  if(document.getElementById(sn).checked == true){

    for(let i = 0; i < id_and_sn.length; i++){
      if(id_and_sn[i][1] == sn) to_write = "<span id = 'spindlesSpan'>" + sn + "</span>" + "<span id = 'spindlesSpan'>" + "H6161H2188" + "</span>" + "<span id = 'spindlesSpan'>" + id_and_sn[i][2] + "</span>"

    }
    
    document.getElementById("selectedSpindles").innerHTML += "<div id = 'spindleRow'> <input type = 'checkbox' class = 'checkbox-spindles' id = '" + sn + "' checked><label for = '" +sn +"'>" + to_write + "</label></div>" 
    document.getElementById("selectAll1").checked = true

  }
  
}

function selectAll(type){
  

  if(type == 1){ //per i selected spindles
    var nodes = document.getElementById('selectedSpindles').childNodes;
    if(document.getElementById("selectAll1").checked == true){
      
       for(let i=0; i<nodes.length; i++) {
        if(nodes[i].id == "spindleRow"){
          var myNode = nodes[i]
          var nodesToSelect = myNode.childNodes
          for(let j = 0; j<nodesToSelect.length; j++){
            nodesToSelect[j].checked = true
          }
        }
      }
    

    }
    else{

      for (let i = 0; i < nodes.length; i++) {
        if (nodes[i].id == "spindleRow") {
          var myNode = nodes[i]
          var nodesToSelect = myNode.childNodes
          for (let j = 0; j < nodesToSelect.length; j++) {
            nodesToSelect[j].checked = false
          }
        }
      }

    }
  }

  else{ //per gli availableSpindles
    var nodes = document.getElementById('availableSpindles').childNodes;
    
    if(document.getElementById("selectAll0").checked == true){
      
      for (let i = 0; i < nodes.length; i++) {
        if (nodes[i].id == "spindleRow") {
          var myNode = nodes[i]
          var nodesToSelect = myNode.childNodes
          for (let j = 0; j < nodesToSelect.length; j++) {
            nodesToSelect[j].checked = true
          }
        }
      }
    var firstDivContent = document.getElementById('availableSpindles');
    var secondDivContent = document.getElementById('selectedSpindles');
    secondDivContent.innerHTML = firstDivContent.innerHTML;

    var nodes2 = document.getElementById('selectedSpindles').childNodes;

    for (let i = 0; i < nodes2.length; i++) {
        if (nodes2[i].id == "spindleRow") {
          var myNode = nodes2[i]
          var nodesToSelect = myNode.childNodes
          for (let j = 0; j < nodesToSelect.length; j++) {
            nodesToSelect[j].checked = true
          }
        }
      }

     document.getElementById("selectAll1").checked = true
   }
   else{

     for (let i = 0; i < nodes.length; i++) {
        if (nodes[i].id == "spindleRow") {
          var myNode = nodes[i]
          var nodesToSelect = myNode.childNodes
          for (let j = 0; j < nodesToSelect.length; j++) {
            nodesToSelect[j].checked = false
          }
        }
      }

   }
  }
  
}

function resetFilters(){

  resetCalendar()

  document.getElementById("day-start").innerHTML = ""
  document.getElementById("day-end").innerHTML = ""
  document.getElementById("request").value = ""
  //document.getElementById("daButton").disabled = false

  id_and_sn = JSON.parse(localStorage.getItem("id_and_sn"))

  clearAvailableSpindles()

  for (i = 0; i < id_and_sn.length; i++) {              

          
                var to_write = "<span id = 'spindlesSpan'>" + id_and_sn[i][1]  + "</span>" + "<span id = 'spindlesSpan'>" + "H6161H2188" + "</span>" + "<span id = 'spindlesSpan'>" + id_and_sn[i][2] + "</span>"
                console.log(to_write)
   
                    document.getElementById("availableSpindles").innerHTML += "<div id = 'spindleRow'> <input type = 'checkbox' class = 'checkbox-spindles' id = '"+ id_and_sn[i][1] +"'onclick = saveSpindle("+ id_and_sn[i][1] +")>"+ "<label for='" + id_and_sn[i][1] + "'>" + to_write + "</label></div>"  
 
}
}


        function displayCalendar(direction){ // 0 vuol dire che ho cliccato "Da", 1 vuol dire che ho cliccato "A"



          var calendar = document.getElementById("calendar-original")
          var dayStart = document.getElementById("day-start")
          var dayEnd = document.getElementById("day-end")
          calendar.hidden = false;
          //Migliorare popup
          //if(direction == 0) calendar.style = "margin-left: 20px;"
          //else calendar.style = "margin-left: 100px;"
          if(direction == 0){
              document.getElementById("daButton").disabled = true
              document.getElementById("aButton").disabled = false
            if (dayStart.innerHTML.length >= 10){
         
              dayStart.innerHTML = "Pick date"
              
          }
        }
        else {
          document.getElementById("daButton").disabled = false
          if (dayEnd.innerHTML.length >= 10){
              dayEnd.innerHTML = "Pick date"
              
          }

        }
      }

        function redirectView(){
            
            var selected_sn = []
            var id_and_sn = JSON.parse(localStorage.getItem("id_and_sn"));
         
            var nodes = document.getElementById('selectedSpindles').childNodes;
            

            
            for(i = 0; i <145; i++){

              var tmp = id_and_sn[i][1]

                for(var j=0; j<nodes.length; j++) {
                  
                  if(nodes[j].id != undefined){
                    if(nodes[j].id == "spindleRow"){

                      var myNode = nodes[j]
                      var nodesToPush = myNode.childNodes;

                      for(let z = 0; z < nodesToPush.length; z++){

                        if ((nodesToPush[z].id == tmp) && (nodesToPush[z].checked == true)) selected_sn.push(id_and_sn[i])

                      }

                    }
                    

                  }
                  
   
            }
          }
            localStorage.setItem("selectedSpindles", JSON.stringify(selected_sn))

            if(selected_sn.length == 0){

                alert("Seleziona almeno uno spindle per continuare!")
                return;
            } 
            else if(selected_sn.length == 1) window.open('singleView.html', '_blank');
            else if (selected_sn.length > 1) window.open('aggregateView.html', '_blank');
            
        }

        function sortFunction(a, b) {
            if (a[0] === b[0]) {
                return 0;
            }
            else {
                return (a[0] < b[0]) ? -1 : 1;
            }
        }

        function compareSecondColumn(a, b) {
            if (a[1] === b[1]) {
                return 0;
            }
            else {
                return (a[1] < b[1]) ? -1 : 1;
            }
        }        

        d3.json("http://arca.diag.uniroma1.it:8082/spindles/breakin?model=H6161H2188&start=0&limit=-1", function(data) {
        
        var tmp_id, tmp_sn

        var id_and_sn = []
        var datasetDataInizio = []
        var datasetDataFine = []

            for(let i = 0; i< 145; i++){

                datasetDataInizio.push([data.breakin_data[i].date, data.breakin_data[i].time ]);
                datasetDataFine.push([data.breakin_data[i].date, data.breakin_data[i].time ]);
                tmp_id = data.breakin_data[i].sequence_id
                tmp_sn = data.breakin_data[i]["serial number"]
                tmp_date = data.breakin_data[i]["date"]
                id_and_sn.push([tmp_id, tmp_sn, tmp_date])
                var to_write = "<span id = 'spindlesSpan'>" + data.breakin_data[i]["serial number"] + "</span>" + "<span id = 'spindlesSpan'>" + "H6161H2188" + "</span>" + "<span id = 'spindlesSpan'>" + tmp_date + "</span>"
                document.getElementById("availableSpindles").innerHTML +=  "<div id = 'spindleRow'><input type = 'checkbox' class = 'checkbox-spindles' + id = '"+ data.breakin_data[i]["serial number"] +"' + onclick = saveSpindle("+ data.breakin_data[i]["serial number"] +")>"+ "<label for='" + data.breakin_data[i]["serial number"] +"'>"+ to_write + "</label></div>" 
                
                
            }
             
            
            localStorage.setItem("id_and_sn", JSON.stringify(id_and_sn))
            datasetDataInizio.sort(sortFunction)
            datasetDataFine.sort(sortFunction)
            //Sorting anche in base all'ora
            //datasetDataInizio.sort(compareSecondColumn)
            //datasetDataFine.sort(compareSecondColumn)


        //console.log(datasetDataInizio, datasetDataFine)
        

        })
        //per ora un solo modello
        var modelli = ["H6161H2188"]

        d3.select("#modello")
        .selectAll('myOptions')
        .data(modelli)
        .enter()
        .append('option')
        .text(function (d) { return d; }) // text showed in the menu
        .attr("value", function (d) { return d; }) // corresponding value returned by the button
    

        
        
    
        d3.select("#calendar-original").on("click", function(d){

          var id_and_sn = JSON.parse(localStorage.getItem("id_and_sn"));
          var id_to_save = []
          var sn_to_save = []

          if(document.getElementById("day-end").innerHTML.length > 10){

            var data_inizio = JSON.parse(localStorage.getItem("day-start"))
          var data_fine = JSON.parse(localStorage.getItem("day-end"))

          var mese_inizio = JSON.parse(localStorage.getItem("month-start"))
          var mese_fine = JSON.parse(localStorage.getItem("month-end"))

          if(mese_inizio == "January") mese_inizio = "01"
          if(mese_inizio == "February") mese_inizio = "02"
          if(mese_inizio == "March") mese_inizio = "03"
          if(mese_inizio == "April") mese_inizio = "04"
          if(mese_inizio == "May") mese_inizio = "05"
          if(mese_inizio == "June") mese_inizio = "06"
          if(mese_inizio == "July") mese_inizio = "07"
          if(mese_inizio == "August") mese_inizio = "08"
          if(mese_inizio == "September") mese_inizio = "09"
          if(mese_inizio == "October") mese_inizio = "10"
          if(mese_inizio == "November") mese_inizio = "11"
          if(mese_inizio == "December") mese_inizio = "12"

          if(mese_fine == "January") mese_fine = "01"
          if(mese_fine == "February") mese_fine = "02"
          if(mese_fine == "March") mese_fine = "03"
          if(mese_fine == "April") mese_fine = "04"
          if(mese_fine == "May") mese_fine = "05"
          if(mese_fine == "June") mese_fine = "06"
          if(mese_fine == "July") mese_fine = "07"
          if(mese_fine == "August") mese_fine = "08"
          if(mese_fine == "September") mese_fine = "09"
          if(mese_fine == "October") mese_fine = "10"
          if(mese_fine == "November") mese_fine = "11"
          if(mese_fine == "December") mese_fine = "12"


          var anno_inizio = JSON.parse(localStorage.getItem("year-start"))
          var anno_fine = JSON.parse(localStorage.getItem("year-end"))

          data_inizio = anno_inizio + "." + mese_inizio + "." + data_inizio
          data_fine = anno_fine + "." + mese_fine + "." + data_fine

          console.log(data_inizio, data_fine)

          
            d3.json("http://arca.diag.uniroma1.it:8082/spindles/breakin?model=H6161H2188&start=0&limit=-1", function(data){
                
                var spindle_sn = document.getElementById('request').value
                
                var to_write = ""
                clearAvailableSpindles()

            for(let i = 0; i< 145; i++){

                
              //console.log(data.breakin_data[i].date)
                if((data.breakin_data[i].date >= data_inizio) && (data.breakin_data[i].date <= data_fine)) {

                    if(document.getElementById("request").value == ""){

                      id_to_save.push(data.breakin_data[i].sequence_id)
                      sn_to_save.push(data.breakin_data[i]["serial number"])
                      to_write = data.breakin_data[i]["serial number"]
                      var real_write = "<span id = 'spindlesSpan'>" + to_write + "</span>" + "<span id = 'spindlesSpan'>" +"H6161H2188" + "</span>"  + "<span id = 'spindlesSpan'>" + data.breakin_data[i]["date"] + "</span>"
                      document.getElementById("availableSpindles").innerHTML += "<div id = 'spindleRow'><input type = 'checkbox' class = 'checkbox-spindles' id = '"+ to_write +"'onclick = saveSpindle("+ to_write +")>"+ "<label for='" + to_write + "'>" + real_write + "</label></div>"

                    }

                    else{

                      var written = document.getElementById("request").value
                      var tmp = data.breakin_data[i]["serial number"]
                      const found = tmp.match(written);
                      if(found != null){
                      var tmp = found["input"]
                      var real_write = data.breakin_data[i]["serial number"] + "   H6161H2188    " + data.breakin_data[i]["date"]
                      if(tmp!=null) document.getElementById("availableSpindles").innerHTML += "<div id = 'spindleRow'><input type = 'checkbox' class = 'checkbox-spindles' id = '"+ tmp +"' onclick = saveSpindle("+ tmp +")>"+ "<label for='" + tmp + "'>" + real_write + "</label></div>"
                      }

                      id_to_save.push(data.breakin_data[i].sequence_id)
                      sn_to_save.push(data.breakin_data[i]["serial number"], data.breakin_data[i]["date"])
                      
                    }

                  
                }
                
            }

            localStorage.setItem("filterHelper", JSON.stringify(sn_to_save))
          
            })

          }

          

        })

        d3.select("#request").on("input", function(d){ //"change"

        

          sleep(1000).then(() => {

            // gestire anche filtro calendario

            var id_and_sn = JSON.parse(localStorage.getItem("id_and_sn"));
            var written = document.getElementById("request").value
            
            

            if((document.getElementById("day-start").innerHTML.length <= 10) || (document.getElementById("day-end").innerHTML.length <= 10)){ // se la data non è stata pickata
              clearAvailableSpindles()

              for(i = 0; i <145; i++){
                var tmp = id_and_sn[i][1]
                const found = tmp.match(written);
                if(found != null){
                var tmp = found["input"]
                var to_write = "<span id = 'spindlesSpan'>" + tmp + "</span>" + "<span id = 'spindlesSpan'>" +"H6161H2188" + "</span>"  + "<span id = 'spindlesSpan'>" + id_and_sn[i][2] + "</span>"
                console.log(id_and_sn[i][2])
                if(tmp!=null) document.getElementById("availableSpindles").innerHTML +=  "<div id = 'spindleRow'><input type = 'checkbox' class = 'checkbox-spindles' id = '"+ tmp +"' onclick = saveSpindle("+ tmp +")>"+ "<label for='" + tmp + "'>" + to_write + "</label></div>" 
            }
            }

            }

            else if((document.getElementById("day-start").innerHTML.length > 10) && (document.getElementById("day-end").innerHTML.length > 10)){ // data pickata, string match in base ai figli del div sopra
              
              clearAvailableSpindles()
              var filterHelper = JSON.parse(localStorage.getItem("filterHelper"))
              var id_and_sn = JSON.parse(localStorage.getItem("id_and_sn"))

             
              
                for(var i=0; i<filterHelper.length; i++) {
                  
                    var tmp = filterHelper[i], date = ""
                    const found = tmp.match(written);
   
                    if(found != null){

                      for(let j = 0; j < id_and_sn.length; j++){
                        if (filterHelper[i] == id_and_sn[j][1]) date = id_and_sn[j][2]

                      }
                      
                      var tmp = found["input"]
                      var to_write = "<span id = 'spindlesSpan'>" + tmp + "</span>" + "<span id = 'spindlesSpan'>" + "H6161H2188" + "</span>"+  "<span id = 'spindlesSpan'>" + date + "</span>" //la data
                      console.log(filterHelper)
                      if(tmp!=null) document.getElementById("availableSpindles").innerHTML += "<div id = 'spindleRow'><input type = 'checkbox' class = 'checkbox-spindles' id = '"+ tmp +"' onclick = saveSpindle("+ tmp +")>"+ "<label for='" + tmp + "'>" + to_write + "</label></div>" 
                      }

                  
            }
      
                
                

            }
    
            
    
            });

            
            
            
            
            })
    
           
        //funzione che fa un update del grafico in base all' attributo del menu a tendina selezionato. Se la spunta su "sovrapponi" c'è, allora creo delle checkbox per ogni attributo richiesto su un div apposito.
       


        


       

        
</script>
</body>
</html>