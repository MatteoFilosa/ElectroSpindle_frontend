<!doctype html>
<html>
<head>
    <!---Step 2-->
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <title>ElectroSpindle Dashboard</title>

    <link rel="stylesheet" href="./style.css"></link>
    <script>
        //inizializzazione array di colori per i grafici
        var colors = [
  '#ff7f50','#87cefa','#da70d6','#32cd32','#6495ed',
  '#ff69b4','#ba55d3','#cd5c5c','#ffa500','#40e0d0'
    ];
        
    
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>
</head>

<body>
<h1>ElectroSpindle: Dashboard</h1>
<!-- <Body background="images/PROVA.png" background-repeat="no-repeat” background-size="cover”>  -->
<Body background="images/test.png" background-repeat="no-repeat” background-size="cover”>  
 
Inserisci SN Spindle<input type = "text" id ="request" maxlength="10" required placeholder="Serial Number"> <button class = "button-green" id = "submit">Filtra</button>

 
<!--Step 2-->
<div id = "svg-div">
    <svg width="500" height="400" id ="svg_default"></svg> <!-- cambiare width e height dinamicamente per funzione zoom-->
</div>



<!-- Initialize a select button -->
<!--<button id = "clear" onclick="clearSvg()" class = "button-blue">Rimuovi tutto</button> -->
<!--<input type="checkbox" id ="sovrapponi" onchange = "checkElements()"> Sovrapponi grafici-->
<!--<input type="checkbox" id ="separati" onchange = "separati()"> Separati -->

Da <select id="selectDataInizio" ></select>
A <select id="selectDataFine" ></select>

Modello <select id="modello"></select>

<div id = "coordinates"></div>
<!--<a href="aggregateView.html" target="_blank" rel="noopener noreferrer">Visualizzazione aggregata</a>
<a href="separateView.html" target="_blank" rel="noopener noreferrer">Visualizzazione separata</a> -->
<div id = "availableSpindles">  
    <h3>Spindle disponibili</h3>

</div>

<script>
        

        function redirectView(){
            
            var selected_sn = []
            var id_and_sn = JSON.parse(localStorage.getItem("id_and_sn"));
            console.log(id_and_sn)
            for(i = 0; i <145; i++){
                var tmp = id_and_sn[i][1]
                console.log(tmp)
                if(document.getElementById(tmp)!=null){
                    if(document.getElementById(tmp).checked) selected_sn.push(id_and_sn[i])
                }
            }
            localStorage.setItem("selectedSpindles", JSON.stringify(selected_sn))

            if(selected_sn.length == 0){

                alert("Seleziona almeno uno spindle per continuare!")
                return;
            } 
            else if(selected_sn.length == 1) window.open('singleView.html', '_blank');
            else if (selected_sn.length > 1) window.open('aggregateView.html', '_blank');
            
        }

        function sortFunction(a, b) {
            if (a[0] === b[0]) {
                return 0;
            }
            else {
                return (a[0] < b[0]) ? -1 : 1;
            }
        }

        function compareSecondColumn(a, b) {
            if (a[1] === b[1]) {
                return 0;
            }
            else {
                return (a[1] < b[1]) ? -1 : 1;
            }
        }        

        d3.json("http://arca.diag.uniroma1.it:8082/spindles/breakin?model=H6161H2188&start=0&limit=-1", function(data) {
        
        var tmp_id, tmp_sn

        var id_and_sn = []
        var datasetDataInizio = []
        var datasetDataFine = []

            for(let i = 0; i< 145; i++){

                datasetDataInizio.push([data.breakin_data[i].date, data.breakin_data[i].time ]);
                datasetDataFine.push([data.breakin_data[i].date, data.breakin_data[i].time ]);
                tmp_id = data.breakin_data[i].sequence_id
                tmp_sn = data.breakin_data[i]["serial number"]
                id_and_sn.push([tmp_id, tmp_sn])
                var to_write = data.breakin_data[i]["serial number"]
                document.getElementById("availableSpindles").innerHTML = document.getElementById("availableSpindles").innerHTML + "<input type = 'checkbox' id = '"+ to_write +"'>"+ to_write 
                
                
            }
            document.getElementById("availableSpindles").innerHTML += "<button id = 'cerca' class = 'button-blue' onClick='redirectView()'>Cerca</button>" 
            
            localStorage.setItem("id_and_sn", JSON.stringify(id_and_sn))
            datasetDataInizio.sort(sortFunction)
            datasetDataFine.sort(sortFunction)
            //Sorting anche in base all'ora
            //datasetDataInizio.sort(compareSecondColumn)
            //datasetDataFine.sort(compareSecondColumn)


        console.log(datasetDataInizio, datasetDataFine)
        d3.select("#selectDataInizio")
        .selectAll('myOptions')
        .data(datasetDataInizio)
        .enter()
        .append('option')
        .text(function (d) { return d; }) // text showed in the menu
        .attr("value", function (d) { return d; }) // corresponding value returned by the button

        d3.select("#selectDataFine")
        .selectAll('myOptions')
        .data(datasetDataFine)
        .enter()
        .append('option')
        .text(function (d) { return d; }) // text showed in the menu
        .attr("value", function (d) { return d; }) // corresponding value returned by the button

        })
        //per ora un solo modello
        var modelli = ["H6161H2188"]

        d3.select("#modello")
        .selectAll('myOptions')
        .data(modelli)
        .enter()
        .append('option')
        .text(function (d) { return d; }) // text showed in the menu
        .attr("value", function (d) { return d; }) // corresponding value returned by the button
    

    
        d3.select("#selectDataFine").on("change", function(d){

            d3.json("http://arca.diag.uniroma1.it:8082/spindles/breakin?model=H6161H2188&start=0&limit=-1", function(data){
                
                var spindle_sn = document.getElementById('request').value
                var data_inizio = document.getElementById('selectDataInizio').value
                var data_fine = document.getElementById('selectDataFine').value
                var id_to_save = []
                var sn_to_save = []
                var to_write = ""
                document.getElementById("availableSpindles").innerHTML = "<h3>Spindle disponibili</h3>"

            for(let i = 0; i< 145; i++){

                

                if((data.breakin_data[i].date >= data_inizio) && (data.breakin_data[i].date <= data_fine)) {

                    id_to_save.push(data.breakin_data[i].sequence_id)
                    sn_to_save.push(data.breakin_data[i]["serial number"])
                    to_write = data.breakin_data[i]["serial number"]
                    document.getElementById("availableSpindles").innerHTML = document.getElementById("availableSpindles").innerHTML + "<input type = 'checkbox' id = '"+ to_write +"'>"+ to_write 
                   
                }
                
            }

            document.getElementById("availableSpindles").innerHTML += "<button id = 'cerca' class = 'button-blue' onClick='redirectView()'>Cerca</button>" + "  "
            

            console.log(id_to_save, sn_to_save)
          
            })

        })

        d3.select("#submit").on("click", function(d){

            var id_and_sn = JSON.parse(localStorage.getItem("id_and_sn"));
            var written = document.getElementById("request").value
            
            document.getElementById("availableSpindles").innerHTML = "<h3>Spindle disponibili</h3>"
    
            for(i = 0; i <145; i++){
                var tmp = id_and_sn[i][1]
                
                const found = tmp.match(written);
                if(found != null){
                var tmp = found["input"]
                console.log(tmp)
                var tmp2 = document.getElementById(tmp)
                console.log(tmp2)
                
                
                if(tmp!=null) document.getElementById("availableSpindles").innerHTML = document.getElementById("availableSpindles").innerHTML + "<input type = 'checkbox' id = '"+ tmp +"'>"+ tmp
            }
            }
            
            document.getElementById("availableSpindles").innerHTML += "<button id = 'cerca' class = 'button-blue' onClick='redirectView()'>Cerca</button>" + "  "
            
            })
    
           
        //funzione che fa un update del grafico in base all' attributo del menu a tendina selezionato. Se la spunta su "sovrapponi" c'è, allora creo delle checkbox per ogni attributo richiesto su un div apposito.
       


        


       

        
</script>
</body>
</html>